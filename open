#!/bin/bash
filelist="$HOME/.local/share/applications/mimeapps.list \
          /usr/share/applications/defaults.list"
appdir=/usr/share/applications
for f in $filelist; do
    [ -f "$f" ] && lists="$lists $f"
done
[ -n "$lists" ] || exit 1
for f in "$@"; do
    [ -e "$f" ] || {
        echo "$f not found"
        continue
    }
    type="$(file -biL "$f" | cut -d ';' -f 1)"
    appfile="$(grep -h $type $lists | head -1 | cut -d = -f 2- | cut -d ';' -f 1)"
    app="$(echo $appfile | sed s/\.desktop//)"
    which "$app" >/dev/null || sudo apt install -y "$app"
    $(sed -n '/^\[Desktop Entry]/,/^\[/p' "$appdir/$appfile" |
        grep "^Exec=" | cut -d = -f 2- | sed 's/ *%U//') "$f" &>/dev/null &
    disown
done
